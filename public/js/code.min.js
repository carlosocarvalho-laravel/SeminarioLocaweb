var $ = jQuery;

var Modules = {};
var Pages = {};
var Arduino = {};
Modules.arduino = {
    start: function() {

        /*
        $(".button-arduino").on('tap click', function(e) {
            e.preventDefault();

            //ratchet.emit('arduino', {command: $(this).attr('data-value')});
            $("#corAtual").html($(this).attr('data-value'));
            objEnviar = {};
            objEnviar.command = $(this).attr('data-value');
            objEnviar.type = 'arduino';
            Arduino.conn.send(JSON.stringify(objEnviar));

            $(".button-arduino").attr('disabled', 'disabled');
            $(".button-arduino").addClass('classGray');
            window.setTimeout(function() {
                $(".button-arduino").removeAttr('disabled');
                $(".button-arduino").removeClass('classGray');
            }, 2500);
        });

        Arduino.conn = new WebSocket('ws://piresedias.com.br:8888');
        Arduino.conn.onopen = function(e) {
            console.log("Websocket Server Arduino OK!");
        };

        Arduino.conn.onmessage = function(e) {

            data = JSON.parse(e.data);
            if (data.type == 'arduino') {

                $(".button-arduino").attr('disabled', 'disabled');

                $(".button-arduino").addClass('classGray');
                $("#corAtual").html(data.command);

                window.setTimeout(function() {
                    $(".button-arduino").removeAttr('disabled');
                    $(".button-arduino").removeClass('classGray');
                }, 2500);

            }
        };

        ratchet.on(1, this.callback);
         */
    },
    callback: function(data) {
        if (data.type == 'arduino') {
            $("#corAtual").html(data.command);

        }
    },
}
Modules.chat = {
	start: function () {
		Reveal.addEventListener('slidechanged', function( event ) {
			Modules.chat.checkCurrentSlide(event.currentSlide);
		});

		$('div.chat .button').on('tap click', function(event) {
			event.preventDefault();
			Modules.chat.sendMessage();
		});

		$('div.chat input').on('keypress', function(e) {
		    if(e.which == 13) {
		        Modules.chat.sendMessage();
		    }
		});

		ratchet.on(1, this.callback);

		Modules.chat.checkCurrentSlide(Reveal.getCurrentSlide());
	},

	callback: function(data) {
		if (data.type == 'chat') {
			$('div.chat .messages').prepend('<p><strong>' + data.nickname + '</strong>: ' + data.message + '</p>');
		}
	},

	checkCurrentSlide: function(currentSlide) {
		if ($(currentSlide).hasClass('chat-slide') && $('body').attr('data-mode') != 'presenter') {
			if (!Modules.chat.initialized) {
				Modules.chat.init();
				$('div.chat').show();
			}
		} else {
			if (Modules.chat.initialized) {
				Modules.chat.initialized = false;
				$('div.chat').hide();
			}
		}
	},

	initialized: false,

	init: function() {
		Modules.chat.initialized = true;
	},

	sendMessage: function() {
		var message = $('div.chat input[type="text"]').val();

		if (message != '') {
			ratchet.emit('chat', {message: message});
			$('div.chat .messages').prepend('<p class="me"><strong>[EU]</strong>: ' + message + '</p>');
			$('div.chat input[type="text"]').val('');
			Modules.sound.horn();
		}
	}
}
Modules.counter = {
	start: function () {
		ratchet.on(1, this.callback);
	},

	callback: function(data) {
		if (data.type == 'counter') {
			$('.users-counter').html(parseInt(data.number/2));
		}
	},
}
Modules.goto = {
    targets: {},

    start: function() {
        $('.goto').on('click', function() {
            target = prompt('Para onde vamos?');

            try {
                slideNumber = Modules.goto.findSlideNumber(target);
                Reveal.slide(slideNumber);
            } catch (e) {
                alert('Não encontramos o slide especificado.');
            }
        });
    },

    findSlideNumber: function(target) {
        if (!Modules.goto.validateTarget(target)) {
            throw {
                name: 'InvalidTarget',
                message: 'Target not found'
            }
        }

        if (isNaN(target)) {
            return Modules.goto.targets[target];
        }

        return target;
    },

    register: function(keys, slide, options) {
        if (!Array.isArray(keys)) {
            keys = [keys];
        }

        keys.forEach(function(key) {
            Modules.goto.targets[key] = slide;
        });
    },

    validateTarget: function(target) {
        if (undefined != Modules.goto.targets[target]) {
            return true;
        }

        if (isNaN(target)) {
            return false;
        }

        slideNumber = target;

        return slideNumber > -1 && slideNumber <= Reveal.getTotalSlides();
    }
};


//register all slides task
setTimeout(function() {
    Modules.goto.register('sorteio', 335);
    Modules.goto.register('painel', 226);
    var i = 1;
    $('div.slides').find('section').each(function(row) {
        var start = $(this).attr('data-on-start');
        if (start !== undefined) {
            var name = $(this).attr('data-slide-name');
            var uid = $(this).attr('data-slide-uid');
            var slide = $(this).index();
            var options = $(this).attr('data-options-slider') || null;
            Modules.goto.register([name, uid], slide, options);
        }
        i += 1;
    });


}, 300);
Modules.horn = {
	start: function() {
		//Listener do botão
		$('.horn.button').on('tap click', function(event) {
			event.preventDefault();

			Modules.sound.horn();

			ratchet.emit('horn', {});
			Modules.horn.countMe++;
			Modules.horn.renderCounter();
		});

		$('.horn.button span').on('tap click', function(event) {
			event.preventDefault();
		});

		//Listener do socket
		ratchet.on(1, this.callback);
	},

	countMe: 0,

	countOthers: 0,

	callback: function(data) {
		if (data.type == 'horn') {
			Modules.sound.horn();
			Modules.horn.countOthers++;
			Modules.horn.renderCounter();
		}
	},

	renderCounter: function() {
		$('.horn.counter').html(Modules.horn.countMe + '/' + Modules.horn.countOthers);
	}
}
Modules.jequiti = {
	start: function () {
		Reveal.addEventListener('slidechanged', function( event ) {
			Modules.jequiti.checkCurrentSlide(event.currentSlide);
		});

		Modules.jequiti.checkCurrentSlide(Reveal.getCurrentSlide());
	},

	checkCurrentSlide: function(currentSlide) {
		if ($(currentSlide).hasClass('jequiti')) {
			setTimeout(function() {
				$('div.jequiti-background').show();

				setTimeout(function() {
					$('div.jequiti-background').hide();
				}, 500);	
			}, 2000);
		}
	}
}
Modules.poll = {
	start: function() {
		//Listener dos botões
		$('.poll .button-level').on('tap click', function(event) {
			event.preventDefault();

			var poll = $(this).closest('.poll');

			if (!$(poll).hasClass('votado')) {
				ratchet.emit('poll', {number: $(poll).attr('data-number'), value: $(this).attr('data-value')});

				if($(poll).attr('data-change') != "true"){
					$(poll).addClass('votado');
				}

				Modules.sound.horn();
			}
		});

		$('.poll .button-level span').on('tap click', function(event) {
			event.preventDefault();
		});

		//Listener do socket
		ratchet.on(1, this.callback);
	},

	callback: function(data) {
		if (data.type == 'poll-result') {
			var poll = $('.poll[data-number="' + data.number + '"]');

			poll.find('.button-level').find('span b').html('0');
			poll.find('.button-level').find('.level').height('0%');

			$.each(data.votes, function(index, quantity) {
				poll.find('.button-level[data-value="' + index + '"]').find('span b').html(quantity);
			});

			$.each(data.percentages, function(index, quantity) {
				poll.find('.button-level[data-value="' + index + '"]').find('.level').height(quantity + '%');
				text = poll.find('.button-level[data-value="' + index + '"]').find('span b').text();
				poll.find('.button-level[data-value="' + index + '"]').find('span b').html(text + ' - ' + quantity + '%');
			});

			//if(data.number == 'pannel'){
			//	if(data.percentages.change >= 50){
			//		Modules.sound.end();
			//	}
			//}
		}
	},
}
Modules.raffle = {
	start: function() {
		//Listener dos botões
		$('.raffle .button-level').on('tap click', function(event) {
			event.preventDefault();

			ratchet.emit('raffle', {});

			Modules.sound.horn();
		});

		$('.poll .button-level span').on('tap click', function(event) {
			event.preventDefault();
		});

		//Listener do socket
		ratchet.on(1, this.callback);
	},

	callback: function(data) {
		if (data.type == 'raffle-result') {
			$(".winner-message").html('');

			if(data.winner == true){
				$(".winner-message").html('Parabens Você é O Vencedor');
			}

			$(".winner-nickname").html(data.name);
		}
	}
};
Modules.sound = {
	start: function() {
		 createjs.Sound.alternateExtensions = ['mp3'];
		 createjs.Sound.registerSound('sounds/horn.ogg', 'horn');
        createjs.Sound.registerSound('sounds/comecar.ogg', 'comecar');
        createjs.Sound.registerSound('sounds/qualresposta.ogg', 'qualresposta');
        createjs.Sound.registerSound('sounds/suspense02.ogg', 'suspense02');
        createjs.Sound.registerSound('sounds/tchau.ogg', 'tchau');
        createjs.Sound.registerSound('sounds/mgsalert.ogg', 'mgsalert');

		 Reveal.addEventListener('slidechanged', function( event ) {
			Modules.sound.checkCurrentSlide(event.currentSlide);
		});

		Modules.sound.checkCurrentSlide(Reveal.getCurrentSlide());
	},

	horn: function() {
		var instance = createjs.Sound.play('horn');
	    instance.volume = 0.5;
	},

	end: function() {
		var instance = createjs.Sound.play('tchau');
		instance.volume = 0.5;
	},

	checkCurrentSlide: function(currentSlide) {
		var instance;
		if ($(currentSlide).hasClass('sound-comecar')) {
			instance = createjs.Sound.play('comecar');
	    	instance.volume = 0.5;
		}  else if ($(currentSlide).hasClass('sound-qualresposta')) {
			instance = createjs.Sound.play('qualresposta');
	    	instance.volume = 0.5;
		}  else if ($(currentSlide).hasClass('sound-suspense02')) {
			instance = createjs.Sound.play('suspense02');
	    	instance.volume = 0.5;
		}  else if ($(currentSlide).hasClass('sound-tchau')) {
            instance = createjs.Sound.play('tchau');
            instance.volume = 0.5;
        }  else if ($(currentSlide).hasClass('sound-mgsalert')) {
            instance = createjs.Sound.play('mgsalert');
            instance.volume = 0.5;
        }
	}
};
//$(document).ready(function() {
	//Use funções de start para cada função do site

	//Inicia todos os módulos
	for(var propertyName in Modules) {
	   Modules[propertyName].start();
	}

	//Inicia todas as páginas
	for(var propertyName in Pages) {
	   Pages[propertyName].start();
	}
//});